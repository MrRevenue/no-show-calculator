
import { useEffect, useRef, useState } from 'react';

export default function NoShowCalculator() {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState({
    country: '', restaurantType: '', seats: '', guestsPerDay: '', openDays: '',
    guestReservationRate: '', averageSpend: '', noShowGuestsLast30Days: '',
    hasOnlineReservation: '', reservationRate: '', reservationTool: '',
    feeForNoShow: '', noShowFee: '', waitlist: ''
  });
  const [formErrors, setFormErrors] = useState({});
  const [showResult, setShowResult] = useState(false);
  const [showContactForm, setShowContactForm] = useState(false);
  const [acceptedPolicy, setAcceptedPolicy] = useState(false);
  const [showPolicyError, setShowPolicyError] = useState(false);
  const contactFormRef = useRef(null);

  useEffect(() => {
    if (showContactForm && contactFormRef.current) {
      contactFormRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [showContactForm]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
    setFormErrors(prev => ({ ...prev, [name]: false }));
  };

  const validateStep = () => {
    const required = {
      1: ['country', 'restaurantType', 'seats', 'guestsPerDay', 'openDays', 'guestReservationRate', 'averageSpend', 'noShowGuestsLast30Days'],
      2: ['hasOnlineReservation', ...(formData.hasOnlineReservation === 'Ja'
        ? ['reservationTool', 'reservationRate', 'feeForNoShow', ...(formData.feeForNoShow === 'Ja' ? ['noShowFee'] : []), 'waitlist']
        : [])]
    };
    const errors = {};
    for (const field of required[step]) {
      if (!formData[field]) errors[field] = true;
    }
    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const nextStep = () => {
    if (validateStep()) setStep(step + 1);
  };

  const reservationToolOptions = [
    '', 'aleno', 'CentralPlanner', 'Formitable', 'Foratable', 'Gastronovi', 'OpenTable',
    'Quandoo', 'Resmio', 'Seatris', 'Tablein', 'The Fork', 'Zenchef', 'ein anderes', 'Das weiß ich gerade nicht'
  ];

  const renderField = (field, label, type = 'text', options = null) => (
    <div key={field} className="mb-4">
      <label className="block text-sm font-medium text-gray-700">{label}</label>
      {options ? (
        <select name={field} value={formData[field]} onChange={handleChange}
          className={`border p-2 w-full rounded ${formErrors[field] ? 'border-red-500' : 'border-gray-300'}`}>
          {options.map((opt, i) => (
            <option key={i} value={opt}>{opt || 'Bitte wählen'}</option>
          ))}
        </select>
      ) : (
        <input name={field} value={formData[field]} onChange={handleChange} type={type}
          className={`border p-2 w-full rounded ${formErrors[field] ? 'border-red-500' : 'border-gray-300'}`} />
      )}
      {formErrors[field] && <p className="text-red-500 text-sm">Bitte ausfüllen</p>}
    </div>
  );

  const currency = formData.country === 'Schweiz' ? 'CHF' : '€';
  const guests = +formData.guestsPerDay || 0;
  const seats = +formData.seats || 0;
  const openDays = +formData.openDays || 0;
  const rate = +formData.guestReservationRate || 0;
  const spend = +formData.averageSpend || 0;
  const noshows = +formData.noShowGuestsLast30Days || 0;
  const noshowFee = +formData.noShowFee || 0;

  const monthlyGuests = guests * openDays * 4.35;
  const totalRes = monthlyGuests * (rate / 100);
  const noshowRate = totalRes > 0 ? Math.max((noshows / totalRes) * 100 - 0.3, 0).toFixed(1) : '0.0';
  const loss = Math.max((noshows * spend) - (noshows * noshowFee), 0);
  const totalRevenue = monthlyGuests * spend;
  const occupancy = seats > 0 ? (monthlyGuests / (seats * openDays * 4.35)) * 100 : 0;
  const upsell = totalRevenue * 0.05;
  const roi = Math.floor((loss + upsell) / 350);
  const format = val => Math.round(val).toLocaleString('de-DE');

  return (
    <div className="max-w-xl mx-auto p-4">
      {!showResult && step === 1 && (
        <>
          <h2 className="text-xl font-bold mb-4">Allgemeine Angaben</h2>
          {renderField("country", "Land", 'text', ['', 'Deutschland', 'Schweiz', 'Österreich', 'Italien'])}
          {renderField("restaurantType", "Restaurant-Typ", 'text', ['', 'Casual', 'Fine Dining', 'Pop-up', 'Hotelrestaurant', 'Restaurant-Gruppe / -Kette'])}
          {renderField("seats", "Anzahl Sitzplätze", 'number')}
          {renderField("guestsPerDay", "Ø Gäste pro Öffnungstag", 'number')}
          {renderField("openDays", "Anzahl Tage pro Woche geöffnet", 'number')}
          {renderField("guestReservationRate", "Wie viel % deiner Gäste reservieren vorab?", 'number')}
          {renderField("averageSpend", "Ø Umsatz pro Gast (Ø Bon)", 'number')}
          {renderField("noShowGuestsLast30Days", "Wie viele No-Shows gab es im Restaurant in den letzten 30 Tagen circa?", 'number')}
          <button onClick={nextStep} className="bg-blue-600 text-white px-4 py-2 rounded">Weiter</button>
        </>
      )}
      {!showResult && step === 2 && (
        <>
          <h2 className="text-xl font-bold mb-4">Reservierungssystem</h2>
          {renderField("hasOnlineReservation", "Ist für das Restaurant ein Online-Reservierungssystem im Einsatz?", 'text', ['', 'Ja', 'Nein'])}
          {formData.hasOnlineReservation === 'Ja' && (
            <>
              {renderField("reservationTool", "Welches Reservierungssystem?", 'text', reservationToolOptions)}
              {renderField("reservationRate", "Wie viel % der Reservierungen erfolgen online?", 'number')}
              {renderField("feeForNoShow", "Werden No-Show-Gebühren erhoben?", 'text', ['', 'Ja', 'Nein'])}
              {formData.feeForNoShow === 'Ja' && renderField("noShowFee", "Wie hoch ist die No-Show-Gebühr pro Gast?", 'number')}
              {renderField("waitlist", "Ist eine Warteliste vorhanden?", 'text', ['', 'Ja', 'Nein'])}
            </>
          )}
          <div className="flex justify-between">
            <button onClick={() => setStep(1)} className="bg-gray-300 px-4 py-2 rounded">Zurück</button>
            <button onClick={() => { if (validateStep()) setShowResult(true); }} className="bg-green-600 text-white px-4 py-2 rounded">Auswertung</button>
          </div>
        </>
      )}
      {showResult && (
        <>
          <h2 className="text-2xl font-bold text-center mb-4">Deine Auswertung</h2>
          <div className="grid gap-4 sm:grid-cols-2 mb-6">
            <div className="bg-pink-50 border border-pink-300 p-4 rounded-xl">
              <h3 className="text-sm text-gray-500">No-Show-Rate (mtl.)</h3>
              <p className="text-xl font-semibold">{noshowRate}%</p>
            </div>
            <div className="bg-pink-50 border border-pink-300 p-4 rounded-xl">
              <h3 className="text-sm text-gray-500">No-Show-Umsatzverlust (mtl.)</h3>
              <p className="text-xl font-semibold">{format(loss)} {currency}</p>
            </div>
            <div className="bg-white border p-4 rounded-xl">
              <h3 className="text-sm text-gray-500">Ø Auslastung (30 Tage)</h3>
              <p className="text-xl font-semibold">{occupancy.toFixed(1)}%</p>
            </div>
            <div className="bg-white border p-4 rounded-xl">
              <h3 className="text-sm text-gray-500">Gesamtumsatz (30 Tage)</h3>
              <p className="text-xl font-semibold">{format(totalRevenue)} {currency}</p>
            </div>
          </div>

          <h3 className="text-lg font-semibold mt-6">Dein Optimierungspotenzial</h3>
          <ul className="space-y-2">
            <li className="bg-green-50 border border-green-200 p-4 rounded-xl">No-Show-Rate: <strong>0%</strong></li>
            <li className="bg-green-50 border border-green-200 p-4 rounded-xl">Zusätzlicher Umsatz ohne No-Shows: <strong>{format(loss)} {currency}</strong></li>
            <li className="bg-green-50 border border-green-200 p-4 rounded-xl">Umsatzsteigerung durch personalisiertes Upselling: <strong>{format(upsell)} – {format(upsell * 3)} {currency}</strong></li>
            <li className="bg-green-50 border border-green-200 p-4 rounded-xl">Return on Investment bei Einsatz von aleno: <strong>{roi}-fach (mindestens)</strong></li>
          </ul>

          <div className="text-center mt-8">
            <p className="mb-2 font-semibold">Möchtest du einen PDF-Report mit individuell auf deinen Betrieb zugeschnittenen Handlungsempfehlungen?</p>
            <button onClick={() => setShowContactForm(true)} className="bg-blue-600 text-white px-4 py-2 rounded">Ja, Report erhalten</button>
          </div>

          {showContactForm && (
            <form className="space-y-4 mt-6" ref={contactFormRef} onSubmit={(e) => {
              e.preventDefault();
              if (!acceptedPolicy) {
                setShowPolicyError(true);
                return;
              }
              alert("PDF-Report wird erstellt und gesendet!");
            }}>
              <input name="firstName" placeholder="Vorname" className="border border-gray-300 p-2 rounded w-full" required />
              <input name="lastName" placeholder="Nachname" className="border border-gray-300 p-2 rounded w-full" required />
              <input name="email" type="email" placeholder="E-Mail" className="border border-gray-300 p-2 rounded w-full" required />
              <input name="mobile" type="tel" placeholder="Mobile-Nummer" className="border border-gray-300 p-2 rounded w-full" required />
              <div className="flex items-start">
                <input type="checkbox" id="policy" checked={acceptedPolicy} onChange={() => { setAcceptedPolicy(!acceptedPolicy); setShowPolicyError(false); }} className="mr-2 mt-1" />
                <label htmlFor="policy" className="text-sm text-gray-700">
                  Ich bin mit der Verarbeitung meiner Daten gemäß der <a href="https://www.aleno.me/de/ppw" target="_blank" className="underline">Datenschutzerklärung</a> einverstanden.
                </label>
              </div>
              {showPolicyError && <p className="text-red-600 text-sm">Bitte bestätige die Datenschutzerklärung.</p>}
              <button type="submit" className="bg-green-600 text-white px-4 py-2 rounded w-full">PDF-Report anfordern</button>
            </form>
          )}
        </>
      )}
    </div>
  );
}
